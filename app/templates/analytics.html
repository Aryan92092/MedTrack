{% extends 'base.html' %}
{% block content %}
<section>
    <h2>Advanced Analytics</h2>
    
    <!-- Analytics Overview -->
    <div class="analytics-overview">
        <div class="cards">
            <div class="card">
                <div class="card-title">Total Consumption (30 days)</div>
                <div class="card-value">{{ consumption.total_consumption if consumption else 0 }}</div>
            </div>
            <div class="card">
                <div class="card-title">Daily Average</div>
                <div class="card-value">{{ "%.1f"|format(consumption.daily_average) if consumption else 0 }}</div>
            </div>
            <div class="card">
                <div class="card-title">Inventory Value</div>
                <div class="card-value">${{ "%.2f"|format(analytics.insights.total_inventory_value) if analytics and analytics.insights else 0 }}</div>
            </div>
            <div class="card">
                <div class="card-title">Risk Items</div>
                <div class="card-value">{{ analytics.insights.risk_distribution.high_risk if analytics and analytics.insights and analytics.insights.risk_distribution else 0 }}</div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="charts-section">
        <h3>Data Visualizations</h3>
        <div class="charts-grid">
            <div class="chart-container">
                <h4>Consumption Trends</h4>
                <canvas id="consumptionChart" width="400" height="200"></canvas>
                <div id="consumptionChartError" class="chart-error" style="display: none;">
                    <p>Unable to load consumption data. Please try again later.</p>
                </div>
            </div>
            <div class="chart-container">
                <h4>Category Distribution</h4>
                <canvas id="categoryChart" width="400" height="200"></canvas>
                <div id="categoryChartError" class="chart-error" style="display: none;">
                    <p>Unable to load category data. Please try again later.</p>
                </div>
            </div>
            <div class="chart-container">
                <h4>Risk Distribution</h4>
                <canvas id="riskChart" width="400" height="200"></canvas>
                <div id="riskChartError" class="chart-error" style="display: none;">
                    <p>Unable to load risk data. Please try again later.</p>
                </div>
            </div>
            <div class="chart-container">
                <h4>Stock Levels</h4>
                <canvas id="stockChart" width="400" height="200"></canvas>
                <div id="stockChartError" class="chart-error" style="display: none;">
                    <p>Unable to load stock data. Please try again later.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ABC Analysis -->
    <div class="analysis-section">
        <h3>ABC Analysis</h3>
        <div class="analysis-tabs">
            <button class="tab-btn active" onclick="showAnalysis('abc')">ABC Analysis</button>
            <button class="tab-btn" onclick="showAnalysis('xyz')">XYZ Analysis</button>
        </div>
        <div id="abc-analysis" class="analysis-content">
            <div class="analysis-grid">
                <div class="analysis-category">
                    <h4>Category A (High Value)</h4>
                    <div id="category-a-items"></div>
                </div>
                <div class="analysis-category">
                    <h4>Category B (Medium Value)</h4>
                    <div id="category-b-items"></div>
                </div>
                <div class="analysis-category">
                    <h4>Category C (Low Value)</h4>
                    <div id="category-c-items"></div>
                </div>
            </div>
        </div>
        <div id="xyz-analysis" class="analysis-content" style="display: none;">
            <div class="analysis-grid">
                <div class="analysis-category">
                    <h4>Category X (Low Variability)</h4>
                    <div id="category-x-items"></div>
                </div>
                <div class="analysis-category">
                    <h4>Category Y (Medium Variability)</h4>
                    <div id="category-y-items"></div>
                </div>
                <div class="analysis-category">
                    <h4>Category Z (High Variability)</h4>
                    <div id="category-z-items"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Smart Recommendations -->
    <div class="recommendations-section">
        <h3>Smart Recommendations</h3>
        <div id="recommendations-list" class="recommendations-list">
            <!-- Recommendations will be loaded here -->
        </div>
    </div>

    <!-- Export Section -->
    <div class="export-section">
        <h3>Export Data</h3>
        <div class="export-options">
            <button class="btn btn-primary" onclick="exportData()">Export to CSV</button>
            <button class="btn btn-secondary" onclick="generateReport()">Generate Report</button>
        </div>
    </div>
</section>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Load analytics data with safe defaults
let analyticsData = {{ analytics | tojson if analytics else '{}' }};
let consumptionData = {{ consumption | tojson if consumption else '{}' }};

// Ensure data has proper structure
if (!analyticsData.insights) {
    analyticsData.insights = {
        total_inventory_value: 0,
        risk_distribution: { low_risk: 0, medium_risk: 0, high_risk: 0 },
        categories: {},
        stock_analysis: { low_stock_count: 0, optimal_stock_count: 0, overstocked_count: 0 }
    };
}

if (!consumptionData.daily_trends) {
    consumptionData.daily_trends = {};
}

// Initialize charts when page loads
document.addEventListener('DOMContentLoaded', function() {
    try {
        loadRecommendations();
        loadABCAnalysis();
        loadXYZAnalysis();
        initializeCharts();
    } catch (error) {
        console.error('Error initializing analytics:', error);
    }
});

// Load smart recommendations
async function loadRecommendations() {
    try {
        const response = await fetch('/analytics/api/recommendations');
        const recommendations = await response.json();
        
        const container = document.getElementById('recommendations-list');
        container.innerHTML = '';
        
        if (recommendations.length === 0) {
            container.innerHTML = '<p>No recommendations at this time.</p>';
            return;
        }
        
        recommendations.forEach(rec => {
            const recDiv = document.createElement('div');
            recDiv.className = `recommendation recommendation-${rec.type}`;
            recDiv.innerHTML = `
                <div class="rec-content">
                    <strong>${rec.message}</strong>
                    <span class="rec-priority">${rec.priority.toUpperCase()}</span>
                    ${rec.suggested_quantity ? `<span class="rec-quantity">Suggested: ${rec.suggested_quantity}</span>` : ''}
                </div>
            `;
            container.appendChild(recDiv);
        });
    } catch (error) {
        console.error('Error loading recommendations:', error);
    }
}

// Load ABC Analysis
async function loadABCAnalysis() {
    try {
        const response = await fetch('/analytics/api/abc-analysis');
        const abcData = await response.json();
        
        // Populate ABC categories
        populateAnalysisCategory('category-a-items', abcData.A || []);
        populateAnalysisCategory('category-b-items', abcData.B || []);
        populateAnalysisCategory('category-c-items', abcData.C || []);
    } catch (error) {
        console.error('Error loading ABC analysis:', error);
    }
}

// Load XYZ Analysis
async function loadXYZAnalysis() {
    try {
        const response = await fetch('/analytics/api/xyz-analysis');
        const xyzData = await response.json();
        
        // Populate XYZ categories
        populateAnalysisCategory('category-x-items', xyzData.X || []);
        populateAnalysisCategory('category-y-items', xyzData.Y || []);
        populateAnalysisCategory('category-z-items', xyzData.Z || []);
    } catch (error) {
        console.error('Error loading XYZ analysis:', error);
    }
}

// Populate analysis category
function populateAnalysisCategory(containerId, items) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    
    if (items.length === 0) {
        container.innerHTML = '<p>No items in this category.</p>';
        return;
    }
    
    items.forEach(item => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'analysis-item';
        itemDiv.innerHTML = `
            <div class="item-name">${item.name}</div>
            <div class="item-metrics">
                ${item.value ? `<span>Value: $${item.value.toFixed(2)}</span>` : ''}
                ${item.consumption_rate ? `<span>Rate: ${item.consumption_rate.toFixed(2)}/day</span>` : ''}
                ${item.coefficient_of_variation ? `<span>CV: ${item.coefficient_of_variation.toFixed(1)}%</span>` : ''}
            </div>
        `;
        container.appendChild(itemDiv);
    });
}

// Initialize charts
function initializeCharts() {
    try {
        // Consumption trends chart
        const consumptionCtx = document.getElementById('consumptionChart');
        if (consumptionCtx) {
            new Chart(consumptionCtx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: Object.keys(consumptionData.daily_trends || {}),
                    datasets: [{
                        label: 'Daily Consumption',
                        data: Object.values(consumptionData.daily_trends || {}),
                        borderColor: 'rgb(34, 197, 94)',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Consumption Trends (30 days)'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Quantity Consumed'
                            }
                        }
                    }
                }
            });
        } else {
            showChartError('consumptionChartError');
        }
    } catch (error) {
        console.error('Error creating consumption chart:', error);
        showChartError('consumptionChartError');
    }

    // Category distribution chart
    try {
        const categoryCtx = document.getElementById('categoryChart');
        if (categoryCtx) {
            const categoryLabels = Object.keys(analyticsData.insights.categories || {});
            const categoryValues = Object.values(analyticsData.insights.categories || {});
            
            new Chart(categoryCtx.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: categoryLabels,
                    datasets: [{
                        data: categoryValues,
                        backgroundColor: [
                            'rgba(34, 197, 94, 0.8)',
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(245, 158, 11, 0.8)',
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(139, 92, 246, 0.8)'
                        ].slice(0, categoryLabels.length)
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Medicine Categories Distribution'
                        },
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        } else {
            showChartError('categoryChartError');
        }
    } catch (error) {
        console.error('Error creating category chart:', error);
        showChartError('categoryChartError');
    }

    // Risk distribution chart
    try {
        const riskCtx = document.getElementById('riskChart');
        if (riskCtx) {
            new Chart(riskCtx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ['Low Risk', 'Medium Risk', 'High Risk'],
                    datasets: [{
                        label: 'Number of Items',
                        data: [
                            analyticsData.insights.risk_distribution.low_risk || 0,
                            analyticsData.insights.risk_distribution.medium_risk || 0,
                            analyticsData.insights.risk_distribution.high_risk || 0
                        ],
                        backgroundColor: [
                            'rgba(34, 197, 94, 0.8)',
                            'rgba(245, 158, 11, 0.8)',
                            'rgba(239, 68, 68, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Risk Distribution'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        } else {
            showChartError('riskChartError');
        }
    } catch (error) {
        console.error('Error creating risk chart:', error);
        showChartError('riskChartError');
    }

    // Stock levels chart
    try {
        const stockCtx = document.getElementById('stockChart');
        if (stockCtx) {
            new Chart(stockCtx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ['Low Stock', 'Optimal Stock', 'Overstocked'],
                    datasets: [{
                        label: 'Number of Items',
                        data: [
                            analyticsData.insights.stock_analysis.low_stock_count || 0,
                            analyticsData.insights.stock_analysis.optimal_stock_count || 0,
                            analyticsData.insights.stock_analysis.overstocked_count || 0
                        ],
                        backgroundColor: [
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(34, 197, 94, 0.8)',
                            'rgba(245, 158, 11, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Stock Level Distribution'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        } else {
            showChartError('stockChartError');
        }
    } catch (error) {
        console.error('Error creating stock chart:', error);
        showChartError('stockChartError');
    }
}

// Show chart error message
function showChartError(errorElementId) {
    const errorElement = document.getElementById(errorElementId);
    if (errorElement) {
        errorElement.style.display = 'block';
    }
}

// Tab switching
function showAnalysis(type) {
    try {
        // Hide all analysis content
        document.querySelectorAll('.analysis-content').forEach(content => {
            content.style.display = 'none';
        });
        
        // Remove active class from all tabs
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Show selected analysis
        const targetElement = document.getElementById(`${type}-analysis`);
        if (targetElement) {
            targetElement.style.display = 'block';
        }
        
        // Add active class to clicked button
        if (event && event.target) {
            event.target.classList.add('active');
        }
    } catch (error) {
        console.error('Error switching analysis tab:', error);
    }
}

// Export data
async function exportData() {
    try {
        const response = await fetch('/reports/api/export');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        
        if (!Array.isArray(data) || data.length === 0) {
            alert('No data available to export');
            return;
        }
        
        // Convert to CSV
        const csv = convertToCSV(data);
        downloadCSV(csv, 'inventory_export.csv');
    } catch (error) {
        console.error('Error exporting data:', error);
        alert('Error exporting data: ' + error.message);
    }
}

// Convert data to CSV
function convertToCSV(data) {
    if (!Array.isArray(data) || data.length === 0) return '';
    
    try {
        const headers = Object.keys(data[0]);
        const csvContent = [
            headers.join(','),
            ...data.map(row => headers.map(header => {
                const value = row[header];
                // Escape quotes and wrap in quotes
                return `"${String(value || '').replace(/"/g, '""')}"`;
            }).join(','))
        ].join('\n');
        
        return csvContent;
    } catch (error) {
        console.error('Error converting to CSV:', error);
        return '';
    }
}

// Download CSV
function downloadCSV(csv, filename) {
    try {
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    } catch (error) {
        console.error('Error downloading CSV:', error);
        alert('Error downloading file');
    }
}

// Generate report
function generateReport() {
    // This would typically generate a PDF report
    alert('Report generation feature coming soon!');
}
</script>
{% endblock %}
