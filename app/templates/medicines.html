{% extends 'base.html' %}
{% block content %}
<section>
    <h2>Medicines (by nearest expiry)</h2>
    
    {% if medicines %}
    <table class="table">
        <thead>
            <tr>
                <th>Name</th>
                <th>Category</th>
                <th>Quantity</th>
                <th>Expiry</th>
                <th>Days Left</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
        {% for m in medicines %}
            <tr class="{% if m.is_expired() %}expired{% elif m.days_until_expiry() <= 30 %}expiring-soon{% endif %}">
                <td>
                    <strong>{{ m.name }}</strong>
                    {% if m.manufacturer %}
                        <br><small class="text-muted">{{ m.manufacturer }}</small>
                    {% endif %}
                </td>
                <td>{{ m.category or 'Uncategorized' }}</td>
                <td>
                    <span class="quantity-badge {% if m.is_low_stock() %}low-stock{% endif %}">
                        {{ m.quantity }}
                    </span>
                </td>
                <td>{{ m.expiry_date.strftime('%Y-%m-%d') }}</td>
                <td>
                    {% if m.is_expired() %}
                        <span class="badge expired">Expired</span>
                    {% else %}
                        <span class="badge {% if m.days_until_expiry() <= 30 %}warning{% else %}success{% endif %}">
                            {{ m.days_until_expiry() }} days
                        </span>
                    {% endif %}
                </td>
                <td>
                    <div class="action-buttons">
                        <button class="btn btn-sm btn-primary" onclick="openConsumeModal({{ m.id }}, '{{ m.name }}', {{ m.quantity }})">
                            Consume
                        </button>
                        <form action="{{ url_for('main.delete_medicine', med_id=m.id) }}" method="post" onsubmit="return confirm('Delete this medicine?')" style="display: inline;">
                            <button class="btn btn-sm btn-danger" type="submit">Delete</button>
                        </form>
                    </div>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty-state">
        <h3>No medicines found</h3>
        <p>Start by adding some medicines to your inventory.</p>
        <a href="{{ url_for('main.add_medicine') }}" class="btn btn-primary">Add Medicine</a>
    </div>
    {% endif %}
</section>

<!-- Consume Medicine Modal -->
<div id="consumeModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Consume Medicine</h3>
            <span class="close" onclick="closeConsumeModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="consumeForm">
                <input type="hidden" id="medicineId" name="medicine_id">
                <div class="form-group">
                    <label for="medicineName">Medicine:</label>
                    <input type="text" id="medicineName" readonly class="form-control">
                </div>
                <div class="form-group">
                    <label for="quantity">Quantity to Consume:</label>
                    <input type="number" id="quantity" name="quantity" min="1" max="1000" required class="form-control">
                    <small class="form-text">Available: <span id="availableQuantity">0</span> units</small>
                </div>
                <div class="form-group">
                    <label for="notes">Notes (optional):</label>
                    <textarea id="notes" name="notes" class="form-control" rows="3" placeholder="Add any notes about this consumption..."></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeConsumeModal()">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="submitConsumption()">Record Consumption</button>
        </div>
    </div>
</div>

<script>
function openConsumeModal(medicineId, medicineName, availableQuantity) {
    document.getElementById('medicineId').value = medicineId;
    document.getElementById('medicineName').value = medicineName;
    document.getElementById('availableQuantity').textContent = availableQuantity;
    document.getElementById('quantity').max = availableQuantity;
    document.getElementById('quantity').value = 1;
    document.getElementById('notes').value = '';
    document.getElementById('consumeModal').style.display = 'block';
}

function closeConsumeModal() {
    document.getElementById('consumeModal').style.display = 'none';
}

async function submitConsumption() {
    const form = document.getElementById('consumeForm');
    const formData = new FormData(form);
    
    const data = {
        medicine_id: parseInt(formData.get('medicine_id')),
        quantity: parseInt(formData.get('quantity')),
        notes: formData.get('notes')
    };
    
    try {
        const response = await fetch('/api/record-consumption', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(result.message);
            closeConsumeModal();
            location.reload(); // Refresh the page to show updated quantities
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        alert('Error recording consumption: ' + error.message);
    }
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('consumeModal');
    if (event.target === modal) {
        closeConsumeModal();
    }
}
</script>

<style>
.table {
    width: 100%;
    border-collapse: collapse;
    margin: 1rem 0;
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.table th {
    background: #f8f9fa;
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    color: #333;
    border-bottom: 2px solid #dee2e6;
}

.table td {
    padding: 1rem;
    border-bottom: 1px solid #dee2e6;
    vertical-align: middle;
}

.table tr:hover {
    background: #f8f9fa;
}

.table tr.expired {
    background: #ffe6e6;
}

.table tr.expiring-soon {
    background: #fff3cd;
}

.quantity-badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    background: #e9ecef;
    border-radius: 4px;
    font-weight: 600;
}

.quantity-badge.low-stock {
    background: #f8d7da;
    color: #721c24;
}

.badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}

.badge.success {
    background: #d4edda;
    color: #155724;
}

.badge.warning {
    background: #fff3cd;
    color: #856404;
}

.badge.expired {
    background: #f8d7da;
    color: #721c24;
}

.action-buttons {
    display: flex;
    gap: 0.5rem;
}

.btn {
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
    font-size: 0.875rem;
    transition: all 0.2s;
}

.btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
}

.btn-primary {
    background: #007bff;
    color: white;
}

.btn-primary:hover {
    background: #0056b3;
}

.btn-danger {
    background: #dc3545;
    color: white;
}

.btn-danger:hover {
    background: #c82333;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #545b62;
}

.empty-state {
    text-align: center;
    padding: 3rem;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.empty-state h3 {
    color: #666;
    margin-bottom: 1rem;
}

.empty-state p {
    color: #999;
    margin-bottom: 2rem;
}

.text-muted {
    color: #6c757d;
}

/* Modal Styles */
.modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: white;
    margin: 5% auto;
    padding: 0;
    border-radius: 8px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid #dee2e6;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    margin: 0;
    color: #333;
}

.close {
    color: #aaa;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close:hover {
    color: #000;
}

.modal-body {
    padding: 1.5rem;
}

.modal-footer {
    padding: 1.5rem;
    border-top: 1px solid #dee2e6;
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
}

.form-group {
    margin-bottom: 1rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: #333;
}

.form-control {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 1rem;
}

.form-control:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
}

.form-text {
    font-size: 0.875rem;
    color: #6c757d;
}

@media (max-width: 768px) {
    .table {
        font-size: 0.875rem;
    }
    
    .table th,
    .table td {
        padding: 0.75rem 0.5rem;
    }
    
    .action-buttons {
        flex-direction: column;
    }
    
    .modal-content {
        width: 95%;
        margin: 10% auto;
    }
}
</style>
{% endblock %}


